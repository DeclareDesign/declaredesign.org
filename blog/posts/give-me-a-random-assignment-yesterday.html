<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="DeclareDesign Team">
<meta name="dcterms.date" content="2018-12-04">

<title>DeclareDesign - Get me a random assignment YESTERDAY</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../static/dd-logo-sm.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title"><strong>Declare</strong>Design</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../getting-started/" rel="" target="">
 <span class="menu-text">Getting started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://book.declaredesign.org" rel="" target="">
 <span class="menu-text">Book</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-software" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Software</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-software">    
        <li>
    <a class="dropdown-item" href="../../declaredesign/" rel="" target="">
 <span class="dropdown-text">DeclareDesign</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../fabricatr/" rel="" target="">
 <span class="dropdown-text">fabricatr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../randomizr/" rel="" target="">
 <span class="dropdown-text">randomizr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../estimatr/" rel="" target="">
 <span class="dropdown-text">estimatr</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Get me a random assignment YESTERDAY</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>DeclareDesign Team </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 4, 2018</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>You’re partnering with an education nonprofit and you are planning on running a randomized control trial in 80 classrooms spread across 20 community schools. The request is in: please send us a spreadsheet with random assignments. The assignment’s gotta be blocked by school, it’s gotta be reproducible, and it’s gotta be tonight. The good news is that you can do all this in a couple of lines of code. We show how using some DeclareDesign tools and then walk through handling of more complex cases.</p>
<section id="you-can-do-it" class="level1">
<h1>You can do it!</h1>
<p>We’ll show first how you do it and then talk through some of the principles, wrinkles, and checks you might do. Here’s the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DeclareDesign)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20181204</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>here_you_go <span class="ot">&lt;-</span> <span class="fu">fabricate</span>(<span class="at">school =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="dv">20</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">class  =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="dv">4</span>, <span class="at">treatment =</span> <span class="fu">block_ra</span>(<span class="at">blocks =</span> school)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The spreadsheet looks like this:</p>
<div class="cell">
<div class="cell-output-display">
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:75%; ">
<table class="table table-striped table-hover table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF;">school</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF;">class</th>
<th data-quarto-table-cell-role="th" style="text-align: right; position: sticky; top: 0; background-color: #FFFFFF;">treatment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">02</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">03</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">04</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">05</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">07</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">08</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: left;">09</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">03</td>
<td style="text-align: left;">10</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: left;">11</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">03</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: left;">14</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: left;">16</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: left;">17</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: left;">19</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">21</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: left;">22</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">23</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: left;">24</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: left;">25</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">07</td>
<td style="text-align: left;">26</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: left;">27</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">07</td>
<td style="text-align: left;">28</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08</td>
<td style="text-align: left;">29</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">30</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08</td>
<td style="text-align: left;">31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">32</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: left;">33</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">34</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: left;">35</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">36</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">37</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">38</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">39</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">40</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">11</td>
<td style="text-align: left;">41</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">11</td>
<td style="text-align: left;">42</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">11</td>
<td style="text-align: left;">43</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">11</td>
<td style="text-align: left;">44</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12</td>
<td style="text-align: left;">45</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">12</td>
<td style="text-align: left;">46</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12</td>
<td style="text-align: left;">47</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">12</td>
<td style="text-align: left;">48</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13</td>
<td style="text-align: left;">49</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">13</td>
<td style="text-align: left;">50</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13</td>
<td style="text-align: left;">51</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">13</td>
<td style="text-align: left;">52</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">14</td>
<td style="text-align: left;">53</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: left;">54</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">14</td>
<td style="text-align: left;">55</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: left;">56</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">15</td>
<td style="text-align: left;">57</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">15</td>
<td style="text-align: left;">58</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">15</td>
<td style="text-align: left;">59</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">15</td>
<td style="text-align: left;">60</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">16</td>
<td style="text-align: left;">61</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">16</td>
<td style="text-align: left;">62</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">16</td>
<td style="text-align: left;">63</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">16</td>
<td style="text-align: left;">64</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17</td>
<td style="text-align: left;">65</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">17</td>
<td style="text-align: left;">66</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17</td>
<td style="text-align: left;">67</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">17</td>
<td style="text-align: left;">68</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">18</td>
<td style="text-align: left;">69</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">18</td>
<td style="text-align: left;">70</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">18</td>
<td style="text-align: left;">71</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">18</td>
<td style="text-align: left;">72</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">19</td>
<td style="text-align: left;">73</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">19</td>
<td style="text-align: left;">74</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">19</td>
<td style="text-align: left;">75</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">19</td>
<td style="text-align: left;">76</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20</td>
<td style="text-align: left;">77</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">20</td>
<td style="text-align: left;">78</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20</td>
<td style="text-align: left;">79</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">20</td>
<td style="text-align: left;">80</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>

</div>
</div>
<p><br></p>
<p>It has 20 schools with 4 classes in each and in each school exactly 2 classes are randomly assigned to treatment. The class variable provides a unique identifier for the experimental units.</p>
<p>The basic work here is done in a single line of code using <code>fabricate</code> from the <code>fabricatr</code> package and <code>block_ra</code> from the <code>randomizr</code> package. The <code>fabricatr</code> package helped us make a multilevel dataset (using <code>add_level</code>) and the <code>randomizr</code> package lets us specify what we want to use as blocks for a blocked random assignment.</p>
<p>You can then save this as a spreadsheet and send off:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(here_you_go, <span class="at">file =</span> <span class="st">"our_assignment_final_revised_final_version_3_latest.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re done.</p>
</section>
<section id="some-principles-and-a-better-workflow" class="level1">
<h1>Some principles and a better workflow</h1>
<p>We got the job done. How well did the approach do in terms of satisfying various randomization desiderata?</p>
<ol type="1">
<li><p>We want random assignment to be <em>transparent</em> in the sense that the process by which units were assigned to treatment conditions is fully understandable to interested parties. The code here provides much of the needed transparency. One point of slippage perhaps here is that the there is no specification for how the units here map into the actual units in the field. There should be no ambiguity as to which classroom we are talking about when we talk about classroom 5 in school 2. If this mapping can be determined later then the randomization can come undone.</p></li>
<li><p>We want the random assignment to be <em>reproducible</em> in the sense that a person using the same software could generate the same random assignment. This is typically assured by setting a random number seed (<code>set.seed(20181204)</code>). If you give the computer a “seed” before randomizing you will get the same “random” result every time. Setting seeds produces a small risk to transparency since in principle one could select a seed to get a result you like. One approach used here is to use a rule for seed setting – such as setting the seed as the date of the randomization. Another is to publicly post a single seed that you or your lab will use for all projects.</p></li>
<li><p>We want to be able to verify properties of the random assignment <em>procedure</em>, not just of a particular assignment. For that, we need to be able to generate many thousands of possible random assignments. It helps immensely if the random assignment procedure is itself a function that can be called repeatedly, rather than a script or a point-and-click workflow. We have not done that here so will walk through that below.</p></li>
</ol>
<p>Rather than writing code that produces an assignment and dataframe directly it can be useful to write down a <em>procedure</em> for generating data and assignment. <code>DeclareDesign</code> functions are good for this since these are mostly <em>functions that make functions</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>make_data  <span class="ot">&lt;-</span> <span class="fu">declare_model</span>(<span class="at">school =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="dv">20</span>),</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">class  =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="dv">4</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>assignment <span class="ot">&lt;-</span> <span class="fu">declare_assignment</span>(<span class="at">Z =</span> <span class="fu">block_ra</span>(<span class="at">blocks =</span> class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With these functions (<code>make_data()</code> and <code>assignment()</code> are functions!) written up, you have both the data structure and the assignment strategy declared. There are many ways now to run these one after another to generate a dataset with assignments. Some examples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>our_assignment <span class="ot">&lt;-</span> <span class="fu">assignment</span>(<span class="fu">make_data</span>())     <span class="co"># base R approach </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>our_assignment <span class="ot">&lt;-</span> <span class="fu">make_data</span>() <span class="sc">%&gt;%</span> assignment  <span class="co"># dplyr approach </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The base R approach and the <code>dplyr</code> approach both run the first function and then apply the second function to the result.</p>
<p>We advocate a design declaration approach that first concatenates the two steps into a design and then draws data using the design.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>design         <span class="ot">&lt;-</span> make_data <span class="sc">+</span> assignment</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>our_assignment <span class="ot">&lt;-</span> <span class="fu">draw_data</span>(design)           <span class="co"># DeclareDesign approach</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:75%; ">
<table class="table table-striped table-hover table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF;">school</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF;">class</th>
<th data-quarto-table-cell-role="th" style="text-align: right; position: sticky; top: 0; background-color: #FFFFFF;">Z</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">02</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">03</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">05</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">07</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">08</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: left;">09</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">03</td>
<td style="text-align: left;">10</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: left;">11</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">03</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">13</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: left;">14</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: left;">16</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: left;">17</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: left;">19</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">21</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: left;">22</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">23</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: left;">24</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: left;">25</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">07</td>
<td style="text-align: left;">26</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: left;">27</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">07</td>
<td style="text-align: left;">28</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08</td>
<td style="text-align: left;">29</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">30</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08</td>
<td style="text-align: left;">31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">32</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: left;">33</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">34</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: left;">35</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">36</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">37</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">38</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">39</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">40</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">11</td>
<td style="text-align: left;">41</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">11</td>
<td style="text-align: left;">42</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">11</td>
<td style="text-align: left;">43</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">11</td>
<td style="text-align: left;">44</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12</td>
<td style="text-align: left;">45</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">12</td>
<td style="text-align: left;">46</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12</td>
<td style="text-align: left;">47</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">12</td>
<td style="text-align: left;">48</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13</td>
<td style="text-align: left;">49</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">13</td>
<td style="text-align: left;">50</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13</td>
<td style="text-align: left;">51</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">13</td>
<td style="text-align: left;">52</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">14</td>
<td style="text-align: left;">53</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: left;">54</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">14</td>
<td style="text-align: left;">55</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: left;">56</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">15</td>
<td style="text-align: left;">57</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">15</td>
<td style="text-align: left;">58</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">15</td>
<td style="text-align: left;">59</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">15</td>
<td style="text-align: left;">60</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">16</td>
<td style="text-align: left;">61</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">16</td>
<td style="text-align: left;">62</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">16</td>
<td style="text-align: left;">63</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">16</td>
<td style="text-align: left;">64</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17</td>
<td style="text-align: left;">65</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">17</td>
<td style="text-align: left;">66</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17</td>
<td style="text-align: left;">67</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">17</td>
<td style="text-align: left;">68</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">18</td>
<td style="text-align: left;">69</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">18</td>
<td style="text-align: left;">70</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">18</td>
<td style="text-align: left;">71</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">18</td>
<td style="text-align: left;">72</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">19</td>
<td style="text-align: left;">73</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">19</td>
<td style="text-align: left;">74</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">19</td>
<td style="text-align: left;">75</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">19</td>
<td style="text-align: left;">76</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20</td>
<td style="text-align: left;">77</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">20</td>
<td style="text-align: left;">78</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20</td>
<td style="text-align: left;">79</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">20</td>
<td style="text-align: left;">80</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>

</div>
</div>
<p><br></p>
<p>A nice feature of the last approach is that not only can you conduct an actual random assignment from the design but you <em>also</em> obtain the probability that each unit is in the condition that it is in. This probability happens to be constant in this example, but it doesn’t need to be. If probabilities vary by unit, a standard approach is to weight each unit by the inverse of the probability of being in the condition that it is in.</p>
<p>We will use this last approach going forward as we look at more bells and whistles.</p>
</section>
<section id="four-bells-and-whistles" class="level1">
<h1>Four bells and whistles</h1>
<section id="incorporate-known-data-into-a-dataframe-before-randomization" class="level2">
<h2 class="anchored" data-anchor-id="incorporate-known-data-into-a-dataframe-before-randomization">Incorporate known data into a dataframe before randomization</h2>
<p>In general the world is not quite as neat as in the example above. Say in fact our data came in like this (of course it would be easier if you were sent a nice dataset but you cannot always count on that):</p>
<blockquote class="blockquote">
<p>Just got the numbers: School 1 has 6 classes, school 2 has 8, schools 4 and 8 have 3 classes, schools 5 and 9 have 5, school 6 has 2, school 10 has 7. Remember we need this yesterday.</p>
</blockquote>
<p>We want to incorporate this information in the data fabrication step. The <code>add_level</code> functionality in the <code>fabricate</code> function is key here for respecting the multilevel nature of the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>make_data <span class="ot">&lt;-</span> <span class="fu">declare_model</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">school =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="dv">10</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">class  =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This new function would generate a data set that reflects the number of classes in each school.</p>
</section>
<section id="make-better-blocks-from-richer-data" class="level2">
<h2 class="anchored" data-anchor-id="make-better-blocks-from-richer-data">Make better blocks from richer data</h2>
<p>Say that you had even richer data about the sampling frame. Then you could use this to do even better assignments. Say this is what you get from your partner:</p>
<blockquote class="blockquote">
<p>We just got information on the class sizes. Here it is: School 1: 20, 25, 23, 30, 12, 15; School 2: 40, 42, 53, 67, 35, 22, 18, 18; School 3: 34, 37, 28, 30; School 4: 18, 24, 20; School 5: 10, 24, 13, 26, 18; School 6: 20, 25; School 7: 28, 34, 19, 24; School 8: 32, 25, 31; School 9: 23, 20, 33, 22, 35; School 10: 20, 31, 34, 35, 18, 23, 22</p>
</blockquote>
<p>We want to incorporate this information in the data fabrication step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>make_data <span class="ot">&lt;-</span> <span class="fu">declare_model</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">school =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="dv">10</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">add_level</span>(<span class="at">N =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">size =</span> <span class="fu">c</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">23</span>, <span class="dv">30</span>, <span class="dv">12</span>, <span class="dv">15</span>,         <span class="co"># students in each classroom of school 1</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">40</span>, <span class="dv">42</span>, <span class="dv">53</span>, <span class="dv">67</span>, <span class="dv">35</span>, <span class="dv">22</span>, <span class="dv">18</span>, <span class="dv">18</span>, <span class="co"># students in each classroom of school 2</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">34</span>, <span class="dv">37</span>, <span class="dv">28</span>, <span class="dv">30</span>,                 <span class="co"># etc...</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">18</span>, <span class="dv">24</span>, <span class="dv">20</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">10</span>, <span class="dv">24</span>, <span class="dv">13</span>, <span class="dv">26</span>, <span class="dv">18</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">20</span>, <span class="dv">25</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">28</span>, <span class="dv">34</span>, <span class="dv">19</span>, <span class="dv">24</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">32</span>, <span class="dv">25</span>, <span class="dv">31</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">23</span>, <span class="dv">20</span>, <span class="dv">33</span>, <span class="dv">22</span>, <span class="dv">35</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">20</span>, <span class="dv">31</span>, <span class="dv">34</span>, <span class="dv">35</span>, <span class="dv">18</span>, <span class="dv">23</span>, <span class="dv">22</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                )))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This new data on class sizes might be very useful.</p>
<p>If the NGO wants to examine individual level outcomes but is using a classroom-level intervention, then this design is using “clustered” random assignment (students clustered into classrooms). As noted in <span class="citation" data-cites="imai2009essential">Imai et al. (<a href="#ref-imai2009essential" role="doc-biblioref">2009</a>)</span>, however, if clusters are of uneven sizes, standard estimation approaches can be biased, even though it’s a randomized experiment. They propose blocking on cluster size in order to address this problem. We’ll use <a href="https://cran.r-project.org/web/packages/blockTools/index.html"><code>blockTools</code></a> (by Ryan T. Moore and Keith Schnakenberg) to block on both school and classroom size within schools.</p>
<p>The <code>block</code> function within <code>blockTools</code> forms blocks as a function of <code>size</code> by pairing similarly-sized classrooms (blocks of size 2 is the default for the <code>block</code> function, though this can be changed). By telling the function that classes are grouped within schools, we can ensure that <code>blockTools</code> will pair classrooms within the same school. We turn this functionality into a design step like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A step to generate blocks</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>block_function <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">block</span>(data, <span class="at">id.vars =</span> <span class="st">"class"</span>, <span class="at">groups =</span> <span class="st">"school"</span>, <span class="at">block.vars =</span> <span class="st">"size"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(data, <span class="at">block_id =</span> <span class="fu">createBlockIDs</span>(out, data, <span class="at">id.var =</span> <span class="st">"class"</span>))}</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>make_blocks <span class="ot">&lt;-</span> <span class="fu">declare_step</span>(<span class="at">handler =</span>  block_function)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s make a design that includes this step and now uses <code>block_id</code> instead of <code>class</code> for blocking:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> make_data <span class="sc">+</span> make_blocks <span class="sc">+</span> <span class="fu">declare_assignment</span>(<span class="at">Z =</span> <span class="fu">block_ra</span>(<span class="at">blocks =</span> block_id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we draw data we now get the block variables and the assignment probabilities included. One out of two units is assigned to each block of two and singleton blocks are assigned independently with 0.5 probability to treatment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>our_df <span class="ot">&lt;-</span> <span class="fu">draw_data</span>(design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:75%; ">
<table class="table table-striped table-hover table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF;">school</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF;">class</th>
<th data-quarto-table-cell-role="th" style="text-align: right; position: sticky; top: 0; background-color: #FFFFFF;">size</th>
<th data-quarto-table-cell-role="th" style="text-align: right; position: sticky; top: 0; background-color: #FFFFFF;">block_id</th>
<th data-quarto-table-cell-role="th" style="text-align: right; position: sticky; top: 0; background-color: #FFFFFF;">Z</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">02</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">03</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">04</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">05</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">07</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">08</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">09</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">10</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">11</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02</td>
<td style="text-align: left;">13</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">14</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">03</td>
<td style="text-align: left;">16</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: left;">17</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">03</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">19</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: left;">20</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">21</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">22</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: left;">23</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">24</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: left;">25</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">26</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">27</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: left;">28</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: left;">29</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">07</td>
<td style="text-align: left;">30</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: left;">31</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">07</td>
<td style="text-align: left;">32</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08</td>
<td style="text-align: left;">33</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">34</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08</td>
<td style="text-align: left;">35</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">36</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: left;">37</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">38</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: left;">39</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">09</td>
<td style="text-align: left;">40</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">41</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">42</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">43</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">44</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">45</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">46</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10</td>
<td style="text-align: left;">47</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>

</div>
</div>
<p><br></p>
<p>The graph below shows that indeed, the blocking formed pairs of classrooms within each school that are similar to one another and correctly left some classrooms in a block by themselves when there was an odd number of classrooms in a school.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>our_df <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(size, block_id, <span class="at">color =</span> <span class="fu">as.factor</span>(Z))) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>school, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="give-me-a-random-assignment-yesterday_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="replicate-yourself" class="level2">
<h2 class="anchored" data-anchor-id="replicate-yourself">Replicate yourself</h2>
<p>If you set up your assignments as functions like this then it is easy to implement the assignment multiple times:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>many_assignments <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">draw_data</span>(design))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s useful to preserve a collection of assignments like this. One advantage is that it lets you see directly what the <em>real</em> assignment probabilities are—not just the intended assignment probabilities. This is especially useful in complex randomizations where different units might get assigned to treatment with quite different probabilities depending on their characteristics (for instance a procedure that rejects assignment profiles because of concerns with imbalance). Calculating the actual probabilities lets you figure out if you have set things up correctly and in some cases can even be useful for correcting things at the analysis stage if you have not!<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In addition the collection of assignments stored in <code>many_assignment</code> are exactly the assignments you should use for some randomization inference tests.</p>
</section>
<section id="save-the-output-to-an-excel-spreadsheet" class="level2">
<h2 class="anchored" data-anchor-id="save-the-output-to-an-excel-spreadsheet">Save the output to an excel spreadsheet</h2>
<p>Your partners mightn’t love csv spreadsheets. But you can easily save to other formats.</p>
<p>Many people love Microsoft Excel. Using the <a href="https://cran.r-project.org/web/packages/writexl/index.html"><code>writexl</code></a> package (by Jeroen Ooms) will make them happy:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(writexl)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_seed</span>(<span class="dv">20181204</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>our_df <span class="ot">&lt;-</span> <span class="fu">draw_data</span>(design)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_xlsx</span>(our_df, <span class="at">path =</span> <span class="st">"students_with_random_assignment.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<ol type="1">
<li>Sometimes you need to <em>make</em> data from bits of information. <code>fabricatr</code> can help with that.</li>
<li>Sometimes you need to make blocks from multiple pieces of information. <code>blockTools</code> can help with that.</li>
<li>Sometimes you need to conduct a random assignment (and make sure it’s reproducible). The functions in <code>randomizr</code> can help with that.</li>
<li>Sometimes you need to share data with people who use Excel. <code>writexl</code> can help with that!</li>
<li>Think of all this together as a part of a design declaration and you get a guarantee that all the bits <em>do</em> fit together in a transparent and replicable way, plus you are half way to a full declaration.</li>
</ol>
</section>
<section id="references." class="level1">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References.</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-imai2009essential" class="csl-entry" role="listitem">
Imai, Kosuke, Gary King, Clayton Nall, et al. 2009. <span>“The Essential Role of Pair Matching in Cluster-Randomized Experiments, with Application to the Mexican Universal Health Insurance Evaluation.”</span> <em>Statistical Science</em> 24 (1): 29–53.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Some tools in the <code>randomizr</code> package make it even easier to obtain matrices of permutations and to learn about properties of your assignments. Using the <code>randomizr</code> package you can declare a randomization like this <code>ra_declaration &lt;- declare_ra(blocks = class)</code> and then get a print out of features of the assignments using <code>summary(ra_declaration)</code> and a whole matrix of assignments like this <code>perm_mat &lt;- obtain_permutation_matrix(ra_declaration)</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>