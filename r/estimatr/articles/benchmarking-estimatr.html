<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="estimatr">
<title>Benchmarking estimatr • estimatr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Benchmarking estimatr">
<meta property="og:description" content="estimatr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">estimatr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/getting-started.html">Getting started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/getting-started.html">Getting started using estimatr</a>
    <a class="dropdown-item" href="../articles/absorbing-fixed-effects.html">Absorbing Fixed Effects with estimatr</a>
    <a class="dropdown-item" href="../articles/estimatr-in-the-tidyverse.html">estimatr in the Tidyverse</a>
    <a class="dropdown-item" href="../articles/benchmarking-estimatr.html">Benchmarking estimatr</a>
    <a class="dropdown-item" href="../articles/emmeans-examples.html">Examples with emmeans</a>
    <a class="dropdown-item" href="../articles/mathematical-notes.html">Mathematical notes for estimatr</a>
    <a class="dropdown-item" href="../articles/regression-tables.html">Regression Tables with estimatr</a>
    <a class="dropdown-item" href="../articles/simulations-debiasing-dim.html">Simulations - Debiasing Difference-in-Means</a>
    <a class="dropdown-item" href="../articles/simulations-ols-variance.html">Simulations - OLS and Variance</a>
    <a class="dropdown-item" href="../articles/stata-wls-hat.html">How Stata's hat matrix differs with weights</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-software">Software</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-software">
    <a class="external-link dropdown-item" href="http://declaredesign.org/r/declaredesign/">DeclareDesign</a>
    <a class="external-link dropdown-item" href="https://declaredesign.org/r/randomizr/">randomizr</a>
    <a class="external-link dropdown-item" href="https://declaredesign.org/r/fabricatr/">fabricatr</a>
    <a class="dropdown-item" href="https://declaredesign.org/r/estimatr/">estimatr</a>
    <a class="external-link dropdown-item" href="https://declaredesign.org/r/designlibrary/">DesignLibrary</a>
    <a class="external-link dropdown-item" href="https://eos.wzb.eu/ipi/DDWizard/">DesignWizard</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://declaredesign.org">declaredesign.org</a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="benchmarking-estimatr_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Benchmarking estimatr</h1>
                        <h4 data-toc-skip class="author">Luke Sonnet</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DeclareDesign/estimatr/blob/HEAD/../vignettes/benchmarking-estimatr.Rmd" class="external-link"><code>../vignettes/benchmarking-estimatr.Rmd</code></a></small>
      <div class="d-none name"><code>benchmarking-estimatr.Rmd</code></div>
    </div>

    
    
<p>This document benchmarks the speed of <code>lm_robust</code> against other estimators. Our performance is slightly better than base R when using classical standard errors, but most of our improvements come when estimating robust standard errors.</p>
<p>The times are milliseconds and are a median over 200 runs for all but the CR2 case, which was taken on a sample of 50 runs, using the <code>microbenchmark</code> package. This benchmarking was done on a 2017 MacBook Air, with a 1.8 GHz Intel Core i5 CPU and 8 GB of memory.</p>
<div class="section level2">
<h2 id="linear-regression">Linear regression<a class="anchor" aria-label="anchor" href="#linear-regression"></a>
</h2>
<p>I test our speed in estimating coefficients, standard errors, and doing inference on four different datasets (500 and 5000 observations; 5 and 50 covariates) and across several different specifications. Below I preview the results comparing <code><a href="../reference/lm_robust.html">lm_robust()</a></code> to base R for fitting coefficients and a commonly used package for robust standard errors, such as the <code>sandwich</code> package. In the two largest datasets, our method is almost always faster and at worst is the same as base R, and only with classical standard errors. When it comes to the biggest gains, using <code><a href="../reference/lm_robust.html">lm_robust()</a></code> to get HC2 or Stata-like cluster-robust standard errors will roughly halve your waiting time. If you want CR2 standard errors, <code><a href="../reference/lm_robust.html">lm_robust()</a></code> can reduce your run time by a factor of 10!</p>
<table class="table">
<thead><tr class="header">
<th>
N. Obs
</th>
<th>
N. Coefs
</th>
<th>
Estimator
</th>
<th>
Classical SEs
</th>
<th>
HC2 SEs
</th>
<th>
Stata clustered SEs
</th>
<th>
CR2 SEs
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
500
</td>
<td>
5
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
7.9
</td>
<td>
7.9
</td>
<td>
7.6
</td>
<td>
<strong>10.6</strong>
</td>
</tr>
<tr class="even">
<td>
</td>
<td>
</td>
<td>
base + sandwich/clubSandwich
</td>
<td>
<strong>2.3</strong>
</td>
<td>
<strong>5</strong>
</td>
<td>
<strong>6.7</strong>
</td>
<td>
45.9
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
5000
</td>
<td>
5
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
18.7
</td>
<td>
<strong>18.8</strong>
</td>
<td>
<strong>17.8</strong>
</td>
<td>
<strong>317</strong>
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
base + sandwich/clubSandwich
</td>
<td>
<strong>6.4</strong>
</td>
<td>
26
</td>
<td>
45.9
</td>
<td>
2121.6
</td>
</tr>
<tr class="even">
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr class="odd">
<td>
500
</td>
<td>
50
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
24.3
</td>
<td>
<strong>28.7
</strong>
</td>
<td>
<strong>29.5</strong>
</td>
<td>
<strong>269</strong>
</td>
</tr>
<tr class="even">
<td>
</td>
<td>
</td>
<td>
base + sandwich/clubSandwich
</td>
<td>
<strong>17.5</strong>
</td>
<td>
43.9
</td>
<td>
69.5
</td>
<td>
404.3
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
5000
</td>
<td>
50
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
<strong>80.8</strong>
</td>
<td>
<strong>111.6</strong>
</td>
<td>
<strong>90.5</strong>
</td>
<td>
<strong>8464</strong>
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
base + sandwich/clubSandwich
</td>
<td>
88.5
</td>
<td>
287
</td>
<td>
480.7
</td>
<td>
2.510^{4}
</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="instrumental-variables-regression">Instrumental variables regression<a class="anchor" aria-label="anchor" href="#instrumental-variables-regression"></a>
</h2>
<table class="table">
<thead><tr class="header">
<th>
N. Obs
</th>
<th>
N. Coefs
</th>
<th>
Estimator
</th>
<th>
Classical SEs
</th>
<th>
HC0 SEs
</th>
<th>
CR2 SEs
</th>
<th>
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
500
</td>
<td>
5
</td>
<td>
<code><a href="../reference/iv_robust.html">estimatr::iv_robust()</a></code>
</td>
<td>
<strong>8.2</strong>
</td>
<td>
<strong>8.9</strong>
</td>
<td>
<strong>11</strong>
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
</td>
<td>
</td>
<td>
AER + ivpack/clubSandwich
</td>
<td>
11.9
</td>
<td>
10.1
</td>
<td>
49.9
</td>
<td>
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
5000
</td>
<td>
5
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
17.8
</td>
<td>
<strong>18.9</strong>
</td>
<td>
<strong>156.9</strong>
</td>
<td>
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
AER + ivpack/clubSandwich
</td>
<td>
<strong>15.7</strong>
</td>
<td>
22.6
</td>
<td>
1814.1
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr class="odd">
<td>
500
</td>
<td>
50
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
<strong>25.8</strong>
</td>
<td>
<strong>26.1</strong>
</td>
<td>
<strong>80.9</strong>
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
</td>
<td>
</td>
<td>
AER + ivpack/clubSandwich
</td>
<td>
46.2
</td>
<td>
51.8
</td>
<td>
310.3
</td>
<td>
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr class="even">
<td>
5000
</td>
<td>
50
</td>
<td>
<code><a href="../reference/lm_robust.html">estimatr::lm_robust()</a></code>
</td>
<td>
<strong>85.4</strong>
</td>
<td>
<strong>93.9</strong>
</td>
<td>
<strong>2594.4</strong>
</td>
<td>
</td>
</tr>
<tr class="odd">
<td>
</td>
<td>
</td>
<td>
AER + ivpack/clubSandwich
</td>
<td>
144.7
</td>
<td>
316.4
</td>
<td>
1.610^{4}
</td>
<td>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="code-that-generated-these-data">Code that generated these data<a class="anchor" aria-label="anchor" href="#code-that-generated-these-data"></a>
</h2>
<p>To see the exact comparisons, see below.</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org/r/estimatr/">estimatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="co"># Create some data sets of different sizes for testing below</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">data_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">5000</span><span class="op">)</span>, ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_size</span><span class="op">)</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">data_size</span><span class="op">$</span><span class="va">ns</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">data_size</span><span class="op">$</span><span class="va">ps</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">p</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre>
<p>First, we can look at the classical standard errors case. We do a few more computations than <code>summary.lm</code> does, and have a bit more overhead.</p>
<pre><code><span><span class="va">test_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'lm_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span>, se_type <span class="op">=</span> <span class="st">"classical"</span><span class="op">)</span>,</span>
<span>    <span class="st">'base'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">200L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>The following table has the median time in milliseconds across 50 runs of each estimator for each of the different data sets.</p>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
lm_robust
</td>
<td align="right">
8
</td>
<td align="right">
19
</td>
<td align="right">
24
</td>
<td align="right">
81
</td>
</tr>
<tr class="even">
<td align="left">
base
</td>
<td align="right">
2
</td>
<td align="right">
6
</td>
<td align="right">
18
</td>
<td align="right">
88
</td>
</tr>
</tbody>
</table>
<p>However, the real speed gains come with robust standard errors. Let’s compare <code>lm_robust</code> to getting “HC2” standard errors and doing inference using them from the <code>coeftest</code> and <code>sandwich</code> packages.</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/" class="external-link">sandwich</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_rob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'lm_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span>, se_type <span class="op">=</span> <span class="st">"HC2"</span><span class="op">)</span>,</span>
<span>    <span class="st">'lm + coeftest + sandwich'</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">lmo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html" class="external-link">coeftest</a></span><span class="op">(</span><span class="va">lmo</span>, vcov <span class="op">=</span> <span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">vcovHC</a></span><span class="op">(</span><span class="va">lmo</span>, type <span class="op">=</span> <span class="st">"HC2"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">200L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
lm_robust
</td>
<td align="right">
8
</td>
<td align="right">
19
</td>
<td align="right">
29
</td>
<td align="right">
112
</td>
</tr>
<tr class="even">
<td align="left">
lm + coeftest + sandwich
</td>
<td align="right">
5
</td>
<td align="right">
26
</td>
<td align="right">
44
</td>
<td align="right">
287
</td>
</tr>
</tbody>
</table>
<p>What about with Stata’s clustered standard errors using <code>tapply</code> and <code>sandwich</code>?</p>
<pre><code><span><span class="co"># Commonly used function attributed mostly to M. Arai replicating Stata </span></span>
<span><span class="co"># clustered SEs in R using sandwich and lmtest packages</span></span>
<span><span class="va">cluster_robust_se</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">cluster</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span></span>
<span>  <span class="va">K</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">rank</span></span>
<span>  <span class="va">dfc</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">M</span><span class="op">/</span><span class="op">(</span><span class="va">M</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">N</span> <span class="op">-</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">uj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/estfun.html" class="external-link">estfun</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">cluster</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>;</span>
<span>  <span class="va">rcse.cov</span> <span class="op">&lt;-</span> <span class="va">dfc</span> <span class="op">*</span> <span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/sandwich.html" class="external-link">sandwich</a></span><span class="op">(</span><span class="va">model</span>, meat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">uj</span><span class="op">)</span><span class="op">/</span><span class="va">N</span><span class="op">)</span></span>
<span>  <span class="va">rcse.se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html" class="external-link">coeftest</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">rcse.cov</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">rcse.cov</span>, <span class="va">rcse.se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">test_cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">/</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'lm_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span></span>
<span>      <span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, </span>
<span>      data <span class="op">=</span> <span class="va">dat</span>, </span>
<span>      clusters <span class="op">=</span> <span class="va">cluster</span>, </span>
<span>      se_type <span class="op">=</span> <span class="st">"stata"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">'lm + coeftest + sandwich'</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">lmo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>      <span class="fu">cluster_robust_se</span><span class="op">(</span><span class="va">lmo</span>, <span class="va">cluster</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">200L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
lm_robust
</td>
<td align="right">
8
</td>
<td align="right">
18
</td>
<td align="right">
30
</td>
<td align="right">
90
</td>
</tr>
<tr class="even">
<td align="left">
lm + coeftest + sandwich
</td>
<td align="right">
7
</td>
<td align="right">
46
</td>
<td align="right">
70
</td>
<td align="right">
481
</td>
</tr>
</tbody>
</table>
<p>The original authors who came up with a generalized version of the CR2 errors and accompanying Satterthwaite-like corrected degrees of freedom have their own package, <a href="https://github.com/jepusto/clubSandwich" class="external-link"><code>clubSandwich</code></a>, that provides estimators for many methods. We show here how much faster our implementation is for simple linear regression.</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://jepusto.github.io/clubSandwich/" class="external-link">clubSandwich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_cr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">/</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'lm_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span></span>
<span>      <span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, </span>
<span>      data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>      clusters <span class="op">=</span> <span class="va">cluster</span>, </span>
<span>      se_type <span class="op">=</span> <span class="st">"CR2"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">'lm + clubSandwich'</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">lmo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="http://jepusto.github.io/clubSandwich/reference/coef_test.html" class="external-link">coef_test</a></span><span class="op">(</span><span class="va">lmo</span>, vcov <span class="op">=</span> <span class="fu"><a href="http://jepusto.github.io/clubSandwich/reference/vcovCR.html" class="external-link">vcovCR</a></span><span class="op">(</span><span class="va">lmo</span>, cluster <span class="op">=</span> <span class="va">cluster</span>, type <span class="op">=</span> <span class="st">"CR2"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">50L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu">create_tab</span><span class="op">(</span><span class="va">test_cr2</span><span class="op">)</span>, col.names <span class="op">=</span> <span class="va">col_names</span><span class="op">)</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
lm_robust
</td>
<td align="right">
11
</td>
<td align="right">
317
</td>
<td align="right">
269
</td>
<td align="right">
8464
</td>
</tr>
<tr class="even">
<td align="left">
lm + clubSandwich
</td>
<td align="right">
46
</td>
<td align="right">
2122
</td>
<td align="right">
404
</td>
<td align="right">
25266
</td>
</tr>
</tbody>
</table>
<p>What about for instrumental variables?</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ivpack</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://jepusto.github.io/clubSandwich/" class="external-link">clubSandwich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"y ~ "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"X"</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span>,</span>
<span>    <span class="st">" | "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Z"</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'iv_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/iv_robust.html">iv_robust</a></span><span class="op">(</span></span>
<span>      <span class="va">form</span>, </span>
<span>      data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>      se_type <span class="op">=</span> <span class="st">"classical"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">'AER::ivreg'</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">ivo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/AER/man/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">200L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu">create_tab</span><span class="op">(</span><span class="va">test_iv</span><span class="op">)</span>, col.names <span class="op">=</span> <span class="va">col_names</span><span class="op">)</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
iv_robust
</td>
<td align="right">
8
</td>
<td align="right">
18
</td>
<td align="right">
26
</td>
<td align="right">
85
</td>
</tr>
<tr class="even">
<td align="left">
AER::ivreg
</td>
<td align="right">
12
</td>
<td align="right">
16
</td>
<td align="right">
46
</td>
<td align="right">
145
</td>
</tr>
</tbody>
</table>
<pre><code><span><span class="va">test_iv_rob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"y ~ "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"X"</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span>,</span>
<span>    <span class="st">" | "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Z"</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'iv_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/iv_robust.html">iv_robust</a></span><span class="op">(</span></span>
<span>      <span class="va">form</span>, </span>
<span>      data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>      se_type <span class="op">=</span> <span class="st">"HC0"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">'AER::ivreg + ivpack::robust.se'</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">ivo</span> <span class="op">&lt;-</span> <span class="fu">robust.se</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/AER/man/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">200L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu">create_tab</span><span class="op">(</span><span class="va">test_iv_rob</span><span class="op">)</span>, col.names <span class="op">=</span> <span class="va">col_names</span><span class="op">)</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
iv_robust
</td>
<td align="right">
9
</td>
<td align="right">
19
</td>
<td align="right">
26
</td>
<td align="right">
94
</td>
</tr>
<tr class="even">
<td align="left">
AER::ivreg + ivpack::robust.se
</td>
<td align="right">
10
</td>
<td align="right">
23
</td>
<td align="right">
52
</td>
<td align="right">
316
</td>
</tr>
</tbody>
</table>
<pre><code><span><span class="va">test_iv_cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">/</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"y ~ "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"X"</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span>,</span>
<span>    <span class="st">" | "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Z"</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">'iv_robust'</span> <span class="op">=</span> <span class="fu"><a href="../reference/iv_robust.html">iv_robust</a></span><span class="op">(</span></span>
<span>      <span class="va">form</span>, </span>
<span>      data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>      clusters <span class="op">=</span> <span class="va">cluster</span>,</span>
<span>      se_type <span class="op">=</span> <span class="st">"CR2"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">'AER::ivreg + clubSandwich'</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">ivo</span> <span class="op">&lt;-</span> <span class="fu">clubSandwich</span><span class="fu">::</span><span class="fu"><a href="http://jepusto.github.io/clubSandwich/reference/coef_test.html" class="external-link">coef_test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/AER/man/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>, cluster <span class="op">=</span> <span class="va">cluster</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">50L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mbo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu">create_tab</span><span class="op">(</span><span class="va">test_iv_cl</span><span class="op">)</span>, col.names <span class="op">=</span> <span class="va">col_names</span><span class="op">)</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">
Estimator
</th>
<th align="right">
N=500, P=5
</th>
<th align="right">
N=500, P=50
</th>
<th align="right">
N=5000, P=5
</th>
<th align="right">
N=500, P=50
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
iv_robust
</td>
<td align="right">
11
</td>
<td align="right">
157
</td>
<td align="right">
81
</td>
<td align="right">
2594
</td>
</tr>
<tr class="even">
<td align="left">
AER::ivreg + clubSandwich
</td>
<td align="right">
50
</td>
<td align="right">
1814
</td>
<td align="right">
310
</td>
<td align="right">
15589
</td>
</tr>
</tbody>
</table>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 3.5.0 (2018-04-23)</span></span>
<span><span class="co">#&gt; Platform: x86_64-apple-darwin15.6.0 (64-bit)</span></span>
<span><span class="co">#&gt; Running under: macOS High Sierra 10.13.3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRblas.0.dylib</span></span>
<span><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRlapack.dylib</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt;  [1] clubSandwich_0.3.2      ivpack_1.2             </span></span>
<span><span class="co">#&gt;  [3] AER_1.2-5               survival_2.41-3        </span></span>
<span><span class="co">#&gt;  [5] sandwich_2.4-0          lmtest_0.9-36          </span></span>
<span><span class="co">#&gt;  [7] zoo_1.8-1               car_3.0-0              </span></span>
<span><span class="co">#&gt;  [9] carData_3.0-1           RcppArmadillo_0.8.500.0</span></span>
<span><span class="co">#&gt; [11] RcppEigen_0.3.3.4.0     microbenchmark_1.4-4   </span></span>
<span><span class="co">#&gt; [13] estimatr_0.8.0         </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] zip_1.0.0         Rcpp_0.12.17      highr_0.6        </span></span>
<span><span class="co">#&gt;  [4] compiler_3.5.0    pillar_1.2.3      cellranger_1.1.0 </span></span>
<span><span class="co">#&gt;  [7] forcats_0.3.0     tools_3.5.0       digest_0.6.15    </span></span>
<span><span class="co">#&gt; [10] evaluate_0.10.1   tibble_1.4.2      lattice_0.20-35  </span></span>
<span><span class="co">#&gt; [13] texreg_1.36.23    rlang_0.2.1       openxlsx_4.1.0   </span></span>
<span><span class="co">#&gt; [16] Matrix_1.2-14     curl_3.2          yaml_2.1.19      </span></span>
<span><span class="co">#&gt; [19] haven_1.1.1       rio_0.5.10        stringr_1.3.1    </span></span>
<span><span class="co">#&gt; [22] knitr_1.20        rprojroot_1.3-2   grid_3.5.0       </span></span>
<span><span class="co">#&gt; [25] data.table_1.11.4 readxl_1.1.0      foreign_0.8-70   </span></span>
<span><span class="co">#&gt; [28] rmarkdown_1.9     Formula_1.2-3     magrittr_1.5     </span></span>
<span><span class="co">#&gt; [31] codetools_0.2-15  splines_3.5.0     backports_1.1.2  </span></span>
<span><span class="co">#&gt; [34] htmltools_0.3.6   abind_1.4-5       stringi_1.2.2</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Luke Sonnet.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
