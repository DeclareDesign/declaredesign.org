<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Absorbing Fixed Effects with estimatr • estimatr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Absorbing Fixed Effects with estimatr">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">estimatr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Getting started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting started using estimatr</a></li>
    <li><a class="dropdown-item" href="../articles/absorbing-fixed-effects.html">Absorbing Fixed Effects with estimatr</a></li>
    <li><a class="dropdown-item" href="../articles/estimatr-in-the-tidyverse.html">estimatr in the Tidyverse</a></li>
    <li><a class="dropdown-item" href="../articles/benchmarking-estimatr.html">Benchmarking estimatr</a></li>
    <li><a class="dropdown-item" href="../articles/emmeans-examples.html">Examples with emmeans</a></li>
    <li><a class="dropdown-item" href="../articles/mathematical-notes.html">Mathematical notes for estimatr</a></li>
    <li><a class="dropdown-item" href="../articles/regression-tables.html">Regression Tables with estimatr</a></li>
    <li><a class="dropdown-item" href="../articles/simulations-debiasing-dim.html">Simulations - Debiasing Difference-in-Means</a></li>
    <li><a class="dropdown-item" href="../articles/simulations-ols-variance.html">Simulations - OLS and Variance</a></li>
    <li><a class="dropdown-item" href="../articles/stata-wls-hat.html">How Stata's hat matrix differs with weights</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-software" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Software</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-software">
<li><a class="external-link dropdown-item" href="http://declaredesign.org/r/declaredesign/">DeclareDesign</a></li>
    <li><a class="external-link dropdown-item" href="https://declaredesign.org/r/randomizr/">randomizr</a></li>
    <li><a class="external-link dropdown-item" href="https://declaredesign.org/r/fabricatr/">fabricatr</a></li>
    <li><a class="dropdown-item" href="https://declaredesign.org/r/estimatr/">estimatr</a></li>
    <li><a class="external-link dropdown-item" href="https://declaredesign.org/r/designlibrary/">DesignLibrary</a></li>
    <li><a class="external-link dropdown-item" href="https://eos.wzb.eu/ipi/DDWizard/">DesignWizard</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://declaredesign.org">declaredesign.org</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="absorbing-fixed-effects_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Absorbing Fixed Effects with estimatr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DeclareDesign/estimatr/blob/main/vignettes/absorbing-fixed-effects.Rmd" class="external-link"><code>vignettes/absorbing-fixed-effects.Rmd</code></a></small>
      <div class="d-none name"><code>absorbing-fixed-effects.Rmd</code></div>
    </div>

    
    
<p>Whether analyzing a block-randomized experiment or adding fixed effects for a panel model, absorbing group means can speed up estimation time. The <code>fixed_effects</code> argument in both <code>lm_robust</code> and <code>iv_robust</code> allows you to do just that, although the speed gains are greatest with “HC1” standard errors. Specifying fixed effects is really simple.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org/r/estimatr/">estimatr</a></span><span class="op">)</span></span>
<span><span class="va">lmr_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span>, data <span class="op">=</span> <span class="va">mtcars</span>, fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">cyl</span><span class="op">)</span></span>
<span><span class="va">lmr_out</span></span></code></pre></div>
<pre><code><span><span class="co">##       Estimate Std. Error   t value  Pr(&gt;|t|)    CI Lower    CI Upper DF</span></span>
<span><span class="co">## hp -0.02403883 0.01503818 -1.598521 0.1211523 -0.05484314 0.006765475 28</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lmr_out</span><span class="op">$</span><span class="va">fixed_effects</span></span></code></pre></div>
<pre><code><span><span class="co">##     cyl4     cyl6     cyl8 </span></span>
<span><span class="co">## 28.65012 22.68246 20.12927</span></span></code></pre>
<p>Before proceeding, three quick notes:</p>
<ul>
<li>Most of the speed gains occur when estimating “HC1” robust standard errors, or “stata” standard errors when there is clustering. This is because most of the speed gains come from avoiding inverting a large matrix of group dummies, but this step is still necessary for “HC2”, “HC3”, and “CR2” standard errors.</li>
<li>While you can specify multiple sets of fixed effects, such as <code>fixed_effects = ~ year + country</code>, please ensure that your model is well-specified if you do so. If there are dependencies or overlapping groups across multiple sets of fixed effects, we cannot guarantee the correct degrees of freedom.</li>
<li>For now, weighted “CR2” estimation is not possible with fixed_effects.</li>
</ul>
<div class="section level2">
<h2 id="speed-gains">Speed gains<a class="anchor" aria-label="anchor" href="#speed-gains"></a>
</h2>
<p>In general, our speed gains will be greatest as the number of groups/fixed effects is large relative to the number of observations. Imagine we have 300 matched-pairs in an experiment.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages for comparison</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/" class="external-link">sandwich</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create matched-pairs dataset using fabricatr</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">40</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org/r/fabricatr/" class="external-link">fabricatr</a></span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://declaredesign.org/r/fabricatr/reference/fabricate.html" class="external-link">fabricate</a></span><span class="op">(</span></span>
<span>  blocks <span class="op">=</span> <span class="fu"><a href="https://declaredesign.org/r/fabricatr/reference/fabricate.html" class="external-link">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">300</span><span class="op">)</span>,</span>
<span>  indiv <span class="op">=</span> <span class="fu"><a href="https://declaredesign.org/r/fabricatr/reference/fabricate.html" class="external-link">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">2</span>, z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">+</span> <span class="va">z</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   blocks indiv z          y</span></span>
<span><span class="co">## 1    001   001 1  1.4961828</span></span>
<span><span class="co">## 2    001   002 0 -0.8595843</span></span>
<span><span class="co">## 3    002   003 1  0.1709400</span></span>
<span><span class="co">## 4    002   004 0 -0.3215731</span></span>
<span><span class="co">## 5    003   005 1 -0.3037704</span></span>
<span><span class="co">## 6    003   006 0 -1.4214866</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># With HC2</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  `base + sandwich` <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span>, <span class="va">dat</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html" class="external-link">coeftest</a></span><span class="op">(</span><span class="va">lo</span>, vcov <span class="op">=</span> <span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">vcovHC</a></span><span class="op">(</span><span class="va">lo</span>, type <span class="op">=</span> <span class="st">"HC2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  `lm_robust` <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span>, <span class="va">dat</span><span class="op">)</span>,</span>
<span>  `lm_robust + fes` <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span>, data <span class="op">=</span> <span class="va">dat</span>, fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">blocks</span><span class="op">)</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in microbenchmark(`base + sandwich` = {: less accurate nanosecond times</span></span>
<span><span class="co">## to avoid potential integer overflows</span></span></code></pre>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##             expr       min        lq      mean    median        uq      max</span></span>
<span><span class="co">##  base + sandwich 167.85187 178.11864 193.48313 187.07062 196.86585 337.6824</span></span>
<span><span class="co">##        lm_robust  41.23050  47.21252  54.30235  51.04418  58.17564 157.4102</span></span>
<span><span class="co">##  lm_robust + fes  25.94972  28.90910  35.82023  31.40495  37.41041 138.2563</span></span>
<span><span class="co">##  neval cld</span></span>
<span><span class="co">##     50 a  </span></span>
<span><span class="co">##     50  b </span></span>
<span><span class="co">##     50   c</span></span></code></pre>
<p>Speed gains are <em>considerably</em> greater with HC1 standard errors. This is because we need to get the hat matrix for HC2, HC3, and CR2 standard errors, which requires inverting that large matrix of dummies we previously avoided doing. HC0, HC1, CR0, and CRstata standard errors do not require this inversion.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># With HC1</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  `base + sandwich` <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span>, <span class="va">dat</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html" class="external-link">coeftest</a></span><span class="op">(</span><span class="va">lo</span>, vcov <span class="op">=</span> <span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">vcovHC</a></span><span class="op">(</span><span class="va">lo</span>, type <span class="op">=</span> <span class="st">"HC1"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  `lm_robust` <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span>,</span>
<span>    <span class="va">dat</span>,</span>
<span>    se_type <span class="op">=</span> <span class="st">"HC1"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  `lm_robust + fes` <span class="op">=</span> <span class="fu"><a href="../reference/lm_robust.html">lm_robust</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">z</span>, </span>
<span>    data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>    fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">blocks</span>,</span>
<span>    se_type <span class="op">=</span> <span class="st">"HC1"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##             expr        min         lq       mean    median         uq</span></span>
<span><span class="co">##  base + sandwich 160.039687 176.330299 193.922425 187.10653 196.272207</span></span>
<span><span class="co">##        lm_robust  34.140413  37.030708  41.163269  40.51331  43.514407</span></span>
<span><span class="co">##  lm_robust + fes   3.458596   3.777535   4.677131   3.98190   4.874449</span></span>
<span><span class="co">##        max neval cld</span></span>
<span><span class="co">##  291.26703    50 a  </span></span>
<span><span class="co">##   58.65431    50  b </span></span>
<span><span class="co">##   11.18406    50   c</span></span></code></pre>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Luke Sonnet.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
